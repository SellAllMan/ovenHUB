local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local invisRunning = false
local IsInvis = false
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local InvisibleCharacter
local invisFix
local invisDied

-- ฟังก์ชัน Respawn (ใช้ตอนตัวละครตายหรือต้องการรีเซ็ต)
local function Respawn()
    IsRunning = false
    if IsInvis == true then
        pcall(function()
            Player.Character = Character
            wait()
            Character.Parent = workspace
            Character:FindFirstChildWhichIsA('Humanoid'):Destroy()
            IsInvis = false
            if InvisibleCharacter then InvisibleCharacter.Parent = nil end
            invisRunning = false
        end)
    elseif IsInvis == false then
        pcall(function()
            Player.Character = Character
            wait()
            Character.Parent = workspace
            Character:FindFirstChildWhichIsA('Humanoid'):Destroy()
            TurnVisible()
        end)
    end
end

-- ฟังก์ชัน TurnVisible: ทำให้ตัวละครกลับมาเห็น
function TurnVisible()
    if IsInvis == false then return end
    if invisFix then invisFix:Disconnect() end
    if invisDied then invisDied:Disconnect() end
    local CF_1 = Player.Character.HumanoidRootPart.CFrame
    Character.HumanoidRootPart.CFrame = CF_1
    if InvisibleCharacter then InvisibleCharacter:Destroy() end
    Player.Character = Character
    Character.Parent = workspace
    IsInvis = false
    Player.Character.Animate.Disabled = true
    Player.Character.Animate.Disabled = false
    invisDied = Character:FindFirstChildOfClass('Humanoid').Died:Connect(function()
        Respawn()
        invisDied:Disconnect()
    end)
    invisRunning = false
    print("You are now visible")
end

-- ฟังก์ชัน MakeInvisible: ทำให้ตัวละครล่องหน
function MakeInvisible()
    if invisRunning then return end
    invisRunning = true

    repeat wait(.1) until Player.Character
    Character = Player.Character
    Character.Archivable = true

    InvisibleCharacter = Character:Clone()
    InvisibleCharacter.Parent = Lighting
    local Void = workspace.FallenPartsDestroyHeight
    InvisibleCharacter.Name = ""

    -- ตั้งค่า transparency ให้ตัว clone
    for i,v in pairs(InvisibleCharacter:GetDescendants()) do
        if v:IsA("BasePart") then
            if v.Name == "HumanoidRootPart" then
                v.Transparency = 1
            else
                v.Transparency = 0.5
            end
        end
    end

    -- ฟังก์ชันเช็คการตายหรือตกนอกแผนที่
    invisFix = RunService.Stepped:Connect(function()
        pcall(function()
            local IsInteger
            if tostring(Void):find('-') then
                IsInteger = true
            else
                IsInteger = false
            end
            local Pos = Player.Character.HumanoidRootPart.Position
            local Y = Pos.Y
            if IsInteger then
                if Y <= Void then Respawn() end
            else
                if Y >= Void then Respawn() end
            end
        end)
    end)

    invisDied = InvisibleCharacter:FindFirstChildOfClass('Humanoid').Died:Connect(function()
        Respawn()
        invisDied:Disconnect()
    end)

    -- ย้ายตัวจริงไปที่ Lighting (ซ่อน)
    local CF_1 = Player.Character.HumanoidRootPart.CFrame
    Character:MoveTo(Vector3.new(0, math.pi * 1000000, 0))
    workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable
    wait(0.2)
    workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    Character.Parent = Lighting

    -- นำ clone มาแทนที่ตัวละครใน workspace
    InvisibleCharacter.Parent = workspace
    InvisibleCharacter.HumanoidRootPart.CFrame = CF_1
    Player.Character = InvisibleCharacter

    Player.Character.Animate.Disabled = true
    Player.Character.Animate.Disabled = false

    IsInvis = true
    print("You are now invisible")
end

-- ฟังก์ชัน Toggle สลับสถานะ
function ToggleInvisible()
    if invisRunning then
        TurnVisible()
    else
        MakeInvisible()
    end
end

-- สร้าง GUI Toggle ปุ่มกด draggable สำหรับมือถือ/ทุกแพลตฟอร์ม
local playerGui = Player:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ToggleInvisibleGui"
screenGui.Parent = playerGui

local dragFrame = Instance.new("Frame")
dragFrame.Size = UDim2.new(0, 130, 0, 50)
dragFrame.Position = UDim2.new(0.5, -65, 0.8, 0)
dragFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
dragFrame.BackgroundTransparency = 0.3
dragFrame.BorderSizePixel = 0
dragFrame.Parent = screenGui
dragFrame.Active = true
dragFrame.Draggable = true -- เปิดลากได้เลย

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, 0, 1, 0)
toggleButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.Text = "Toggle OFF"
toggleButton.Parent = dragFrame
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextScaled = true

-- ตัวแปรสถานะ toggle GUI (แยกจาก invisRunning)
local toggleOn = false

toggleButton.MouseButton1Click:Connect(function()
    ToggleInvisible()
    toggleOn = not toggleOn
    if toggleOn then
        toggleButton.Text = "Toggle ON"
        toggleButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    else
        toggleButton.Text = "Toggle OFF"
        toggleButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    end
end)

-- (ถ้าต้องการ) ผูกปุ่มคีย์บอร์ด T สำหรับทดสอบ toggle
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.T then
        ToggleInvisible()
        toggleOn = not toggleOn
        if toggleOn then
            toggleButton.Text = "Toggle ON"
            toggleButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        else
            toggleButton.Text = "Toggle OFF"
            toggleButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        end
    end
end)
